<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Festa QR ‚Äî Leitor Robust</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; display:flex; flex-direction:column; align-items:center; min-height:100vh; }
  h1 { text-align:center; font-size:1.3rem; margin:12px 0; }
  #reader { width:90%; max-width:380px; margin:8px auto; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-bottom:8px;}
  button, input[type=file] { padding:10px 12px; border-radius:8px; border:none; background:#007bff; color:#fff; cursor:pointer; }
  button.secondary{ background:#6c757d; }
  #resultado { width:90%; background:#fff; padding:10px; border-radius:8px; text-align:center; margin-top:8px; }
  #resumo { width:90%; background:#e9ecef; padding:10px; border-radius:8px; margin-top:8px; text-align:center;}
  #historico { width:90%; background:#fff; padding:10px; border-radius:8px; margin-top:8px; max-height:260px; overflow:auto; }
  .entrada{ border-bottom:1px solid #eee; padding:6px 0; }
</style>
</head>
<body>
  <h1>üéüÔ∏è Controle de Acesso ‚Äî Leitor</h1>

  <div class="controls">
    <input id="importar" type="file" accept=".json">
    <button id="btnCamera">üì∑ Iniciar C√¢mera</button>
    <button id="btnParar">‚è∏Ô∏è Parar C√¢mera</button>
  </div>

  <div id="reader"></div>

  <div id="resultado">Resultado: ‚Äî</div>
  <div id="resumo"></div>

  <div id="historico">
    <h3 style="text-align:center;margin:6px 0;">Hist√≥rico de Entradas</h3>
    <div id="listaHistorico"></div>
  </div>

<script>
/* ====== Estado ====== */
let familias = {}; 
let historico = JSON.parse(localStorage.getItem('historico') || '[]');
let html5QrcodeScanner = null;
let scannerPaused = false;

/* ====== Utilidades ====== */
function normalizeId(x){
  return String(x || "").trim().toUpperCase();
}

function tryExtractFamId(text){
  if(!text) return null;

  // se QR cont√©m JSON com `id`
  try {
    const parsed = JSON.parse(text);
    if(parsed && (parsed.id || parsed.ID)) 
      return normalizeId(parsed.id || parsed.ID);
  } catch(e){}

  // regex FAMxxxxx
  const m = text.match(/(FAM\w{3,})/i);
  if(m) return normalizeId(m[1]);

  return normalizeId(text);
}

/* ====== Importar lista ====== */
document.getElementById('importar').addEventListener('change', function(evt){
  const file = evt.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    const data = JSON.parse(e.target.result);

    if(!confirm("Carregar nova lista ir√° apagar o hist√≥rico atual. Continuar?")) return;

    historico = [];
    localStorage.setItem('historico', '[]');

    familias = {};

    if(Array.isArray(data)){
      data.forEach(f=>{
        const id = normalizeId(f.id);
        familias[id] = {...f, id, entrou: !!f.entrou};
      });
    } else {
      Object.keys(data).forEach(k=>{
        const f = data[k];
        const id = normalizeId(f.id || k);
        familias[id] = {...f, id, entrou: !!f.entrou};
      });
    }

    localStorage.setItem('familias', JSON.stringify(familias));

    alert('Lista carregada!');
    atualizarResumo();
    atualizarHistorico();
  };

  reader.readAsText(file);
});

/* ====== C√¢mera ====== */
document.getElementById('btnCamera').onclick = iniciarCamera;
document.getElementById('btnParar').onclick = pararCamera;

function iniciarCamera(){
  if(html5QrcodeScanner) return;

  html5QrcodeScanner = new Html5Qrcode("reader");

  html5QrcodeScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 250, height: 250 } },
    onScanSuccess,
    () => {}
  )
  .catch(err => {
    alert("Erro ao iniciar c√¢mera: " + err);
    html5QrcodeScanner = null;
  });
}

function pararCamera(){
  if(!html5QrcodeScanner) return;

  html5QrcodeScanner.stop()
    .then(() => {
      html5QrcodeScanner.clear();
      html5QrcodeScanner = null;
    });
}

/* ====== PROCESSAR QR ====== */
let lastScan = null;

async function onScanSuccess(decodedText){

  // evitar leituras repetidas r√°pidas
  if(decodedText === lastScan) return;
  lastScan = decodedText;
  setTimeout(()=> lastScan = null, 1200);

  // pausar scanner (SEM parar c√¢mera!)
  if(html5QrcodeScanner && !scannerPaused){
    html5QrcodeScanner.pause(true);
    scannerPaused = true;
  }

  const id = tryExtractFamId(decodedText);

  if(!id || !familias[id]){
    vibrarErro();
    alert("‚ùå QR inv√°lido!");
    retomarCamera();
    return;
  }

  const fam = familias[id];

  /* === Se j√° entrou === */
  if(fam.entrou){
    vibrarErro();
    alert(`‚ö†Ô∏è ${fam.nome} j√° entrou anteriormente.`);
    atualizarResumo();
    atualizarHistorico();
    retomarCamera();
    return;
  }

  /* === ENTRADA V√ÅLIDA === */
  vibrarOK();

  fam.entrou = true;

  const hora = new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
  historico.unshift({
      nome: fam.nome,
      adultos: fam.adultos,
      criancas: fam.criancas,
      hora
  });

  localStorage.setItem('familias', JSON.stringify(familias));
  localStorage.setItem('historico', JSON.stringify(historico));

  document.getElementById('resultado').innerHTML =
    `‚úÖ <strong>${fam.nome}</strong><br>${fam.adultos} adultos ‚Ä¢ ${fam.criancas} crian√ßas<br><em>${hora}</em>`;

  atualizarResumo();
  atualizarHistorico();
  retomarCamera();
}

/* ====== Vibra√ß√£o ====== */
function vibrarOK(){
  if(navigator.vibrate) navigator.vibrate([100]);
}

function vibrarErro(){
  if(navigator.vibrate) navigator.vibrate([60,60,60]);
}

/* ====== Retomar leitura SEM travar ====== */
function retomarCamera(){
  setTimeout(()=>{
    if(html5QrcodeScanner){
      html5QrcodeScanner.resume();
      scannerPaused = false;
    }
  }, 900);
}

/* ====== UI ====== */
function atualizarResumo(){
  const list = Object.values(familias);
  const totalAdultos = list.filter(f=>f.entrou).reduce((s,f)=>s+Number(f.adultos),0);
  const totalCriancas = list.filter(f=>f.entrou).reduce((s,f)=>s+Number(f.criancas),0);
  document.getElementById('resumo').innerHTML =
    `<strong>Adultos:</strong> ${totalAdultos} ‚Ä¢ <strong>Crian√ßas:</strong> ${totalCriancas}`;
}

function atualizarHistorico(){
  const box = document.getElementById('listaHistorico');
  box.innerHTML = "";
  historico.forEach(h=>{
    const div = document.createElement("div");
    div.className = "entrada";
    div.innerHTML = `<strong>${h.nome}</strong> ‚Äî ${h.adultos}A / ${h.criancas}C <span style="float:right">${h.hora}</span>`;
    box.appendChild(div);
  });
}

/* ====== Load inicial ====== */
window.onload = ()=>{
  const data = localStorage.getItem('familias');
  if(data) familias = JSON.parse(data);
  atualizarResumo();
  atualizarHistorico();
};
</script>

</body>
</html>
