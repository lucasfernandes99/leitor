<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Controle de Acesso üéü</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
  body{
    margin:0;
    font-family:Arial, sans-serif;
    background:#f2f2f2;
    text-align:center;
  }
  h1{margin:18px 0;font-size:1.5rem;}

  #reader{
    width:90%;
    max-width:350px;
    margin:10px auto;
  }

  button{
    background:#007bff;
    color:white;
    border:0;
    padding:12px 18px;
    margin:6px;
    border-radius:10px;
    font-size:1rem;
    cursor:pointer;
  }
  button.stop{ background:#6c757d; }

  #resultado{
    width:90%;
    max-width:500px;
    margin:10px auto;
    padding:12px;
    border-radius:12px;
    background:white;
    font-size:1.1rem;
  }

  #resumo, #historico{
    width:90%;
    max-width:500px;
    margin:10px auto;
    padding:12px;
    border-radius:12px;
    background:white;
  }

  .entrada{
    border-bottom:1px solid #ddd;
    padding:6px 4px;
    font-size:0.95rem;
  }

  #overlay{
    position:fixed;
    top:0;left:0;
    width:100vw;height:100vh;
    background:transparent;
    pointer-events:none;
    transition:0.3s;
    opacity:0;
  }
</style>
</head>
<body>

<div id="overlay"></div>

<h1>üéü Controle de Acesso</h1>

<button id="btnStart">üì∑ Iniciar C√¢mera</button>
<button id="btnStop" class="stop">‚è∏ Parar</button>

<div id="reader"></div>

<div id="resultado">Aguardando leitura...</div>

<div id="resumo"></div>

<div id="historico">
  <h3>Hist√≥rico</h3>
  <div id="listaHistorico"></div>
</div>


<button id="btnReset" style="background:#ff4444">üßπ Resetar Entradas</button>

<script>
/* ===== CONFIG ===== */
const RESET_PASSWORD = "niverdamalu";
let scanner = null;
let paused = false;

/* ===== DADOS ===== */
let familias = JSON.parse(localStorage.getItem("familias") || "{}");
let historico = JSON.parse(localStorage.getItem("historico") || "[]");

/* ===== Fun√ß√µes UI ===== */

function vibra(tipo){
  if(!navigator.vibrate) return;

  if(tipo==="ok") navigator.vibrate([30,50,30]);
  else if(tipo==="erro") navigator.vibrate([80,50,80]);
}

function mostrarOverlay(cor){
  const o = document.getElementById("overlay");
  o.style.background = cor;
  o.style.opacity = 0.6;
  setTimeout(()=>{ o.style.opacity=0; },400);
}


/* ===== Atualiza√ß√£o UI ===== */

function atualizarResumo(){
  const lista = Object.values(familias);
  const totalFam = lista.length;
  const adultos = lista.filter(f=>f.entrou).reduce((s,f)=>s+(f.adultos||0),0);
  const criancas = lista.filter(f=>f.entrou).reduce((s,f)=>s+(f.criancas||0),0);

  document.getElementById("resumo").innerHTML = `
    üë®‚Äçüë©‚Äçüëß Fam√≠lias: <b>${totalFam}</b> <br>
    üßë Adultos: <b>${adultos}</b> ‚Ä¢ üëß Crian√ßas: <b>${criancas}</b>
  `;
}

function atualizarHistorico(){
  const div = document.getElementById("listaHistorico");
  div.innerHTML = "";

  historico.forEach(h=>{
    const el = document.createElement("div");
    el.className="entrada";
    el.innerHTML = `<b>${h.nome}</b> ‚Äî ${h.adultos}A / ${h.criancas}C <span style="float:right">${h.hora}</span>`;
    div.appendChild(el);
  });
}

/* ===== Reset ===== */
document.getElementById("btnReset").onclick = ()=>{
  const senha = prompt("Digite a senha para reset:");

  if(senha !== RESET_PASSWORD){
    vibra("erro");
    alert("‚ùå Senha incorreta!");
    
    // retomando c√¢mera caso pausada
    if(scanner && paused){
      scanner.resume();
      paused = false;
    } else if(!scanner){
      iniciarCamera();
    }

    return;
  }

  vibra("ok");

  Object.values(familias).forEach(f=>f.entrou=false);
  historico = [];

  localStorage.setItem("familias", JSON.stringify(familias));
  localStorage.setItem("historico", "[]");

  document.getElementById("resultado").innerHTML = "Aguardando leitura...";
  document.getElementById("listaHistorico").innerHTML = "";

  atualizarResumo();

  alert("‚úî Reset conclu√≠do!");

  setTimeout(()=>{
    pararCamera();
    iniciarCamera();
  },500);
};


/* ===== C√¢mara ===== */

document.getElementById("btnStart").onclick = iniciarCamera;
document.getElementById("btnStop").onclick = pararCamera;

async function iniciarCamera(){
  if(scanner) return;

  scanner = new Html5Qrcode("reader");

  scanner.start(
    { facingMode:"environment" },
    { fps:10, qrbox:{ width:250, height:250 }},
    resultadoQR
  );

  paused = false;
}

function pararCamera(){
  if(!scanner) return;
  scanner.stop();
  scanner.clear();
  scanner=null;
}


/* ===== Leitura ===== */

let ultima = null;

function resultadoQR(text){

  if(text===ultima) return;
  ultima=text;
  setTimeout(()=>ultima=null,1300);

  const id = text.trim().toUpperCase();

  const fam = familias[id];

  if(!fam){
    document.getElementById("resultado").innerHTML = "‚ùå QR inv√°lido!";
    mostrarOverlay("rgba(255,0,0,0.6)");
    vibra("erro");
    return;
  }

  if(fam.entrou){
    document.getElementById("resultado").innerHTML = `‚ö†Ô∏è <b>${fam.nome}</b> j√° entrou!`;
    mostrarOverlay("rgba(255,165,0,0.6)");
    vibra("erro");
    return;
  }

  // registrar entrada
  fam.entrou = true;
  const hora = new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});

  historico.unshift({ nome:fam.nome, adultos:fam.adultos, criancas:fam.criancas, hora });

  localStorage.setItem("familias", JSON.stringify(familias));
  localStorage.setItem("historico", JSON.stringify(historico));

  document.getElementById("resultado").innerHTML = `
    ‚úîÔ∏è <b>${fam.nome}</b><br>
    ${fam.adultos} adultos ‚Ä¢ ${fam.criancas} crian√ßas<br>
    ${hora}
  `;

  vibra("ok");
  mostrarOverlay("rgba(0,200,0,0.6)");

  atualizarResumo();
  atualizarHistorico();
}

/* ===== Init ===== */
atualizarResumo();
atualizarHistorico();
</script>
</body>
</html>
