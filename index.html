<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Festa QR ‚Äî Leitor</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
  body { font-family: Arial; margin:0; padding:0; background:#f5f5f5;
         display:flex; flex-direction:column; align-items:center; min-height:100vh; }
  h1 { text-align:center; font-size:1.4rem; margin:14px 0; }
  #reader { width:90%; max-width:380px; margin-top:10px; }
  button { padding:11px 18px; margin:6px; font-weight:bold;
           border:none; border-radius:8px; background:#007bff; color:white; cursor:pointer; }
  button.secondary { background:#6c757d; }
  #resultado, #resumo { width:90%; background:#fff; padding:12px;
                        border-radius:10px; text-align:center; margin-top:10px; }
  #historico { width:90%; background:#fff; padding:10px; border-radius:10px;
               margin-top:10px; max-height:260px; overflow:auto; }
  .entrada { border-bottom:1px solid #ddd; padding:6px 0; }
  #overlay {
    position: fixed; top:0; left:0; width:100%; height:100%;
    display:none; justify-content:center; align-items:center;
    color:white; font-size:3rem; font-weight:bold;
    z-index:9999; text-shadow:2px 2px 10px black;
  }
</style>
</head>
<body>

<h1>üéü Controle de Acesso</h1>

<button id="btnCamera">üì∑ Iniciar C√¢mera</button>
<button id="btnParar" class="secondary">‚è∏Ô∏è Parar</button>

<div id="reader"></div>

<div id="resultado">Aguardando leitura...</div>
<div id="resumo"></div>

<div id="historico">
  <h3 style="text-align:center;margin:6px 0;">Hist√≥rico</h3>
  <div id="listaHistorico"></div>
</div>

<div id="overlay"></div>

<script>
const RESET_PASSWORD = "niverdamalu";
const JSON_URL = "familias.json";

let familias = {};
let historico = JSON.parse(localStorage.getItem("historico") || "[]");
let scanner = null;
let paused = false;

async function carregarLista(){
  try{
    const res = await fetch(JSON_URL + "?v=" + Date.now());
    const data = await res.json();

    familias = {};
    Object.keys(data).forEach(k=>{
      familias[k.toUpperCase()] = {...data[k], entrou:false};
    });

    localStorage.setItem("familias", JSON.stringify(familias));
    atualizarResumo();
  }catch(e){
    console.warn("Erro ao carregar JSON:", e);
  }
}

function iniciarCamera(){
  if(scanner) return;
  scanner = new Html5Qrcode("reader");
  scanner.start({ facingMode:"environment" }, { fps:10, qrbox:{width:250,height:250} }, onScan);
}

function pararCamera(){
  if(!scanner) return;
  scanner.stop().then(()=>{ scanner.clear(); scanner=null; });
}

function overlay(cor, texto){
  const box=document.getElementById("overlay");
  box.style.background=cor;
  box.innerHTML=texto;
  box.style.display="flex";
  setTimeout(()=> box.style.display="none", 1000);
}

function vibrar(padrao){
  if(navigator.vibrate) navigator.vibrate(padrao);
}

let ultima = null;

function onScan(texto){
  if(texto===ultima) return;
  ultima=texto;
  setTimeout(()=> ultima=null, 1200);

  if(!paused){
    scanner.pause(true);
    paused=true;
  }

  const id = texto.trim().toUpperCase();
  const fam = familias[id];

  if(!fam){
    vibrar([80,80,80]);
    overlay("rgba(200,0,0,0.8)", "‚õî Inv√°lido");
    return retomar();
  }

  if(fam.entrou){
    vibrar([60,60,60]);
    overlay("rgba(230,140,0,0.85)", "‚ö† J√° Registrado");
    return retomar();
  }

  vibrar([100]);
  overlay("rgba(0,150,0,0.8)", "‚úî Liberado");

  fam.entrou=true;
  const hora=new Date().toLocaleTimeString("pt-BR",{hour:'2-digit',minute:'2-digit'});
  historico.unshift({...fam,hora});
  localStorage.setItem("familias",JSON.stringify(familias));
  localStorage.setItem("historico",JSON.stringify(historico));

  document.getElementById("resultado").innerHTML=
  `‚úî <strong>${fam.nome}</strong><br>${fam.adultos} adultos ‚Ä¢ ${fam.criancas} crian√ßas<br><em>${hora}</em>`;

  atualizarResumo();
  atualizarHistorico();
  retomar();
}

function retomar(){
  setTimeout(()=>{
    if(scanner){
      scanner.resume();
      paused=false;
    }
  },900);
}

function atualizarResumo(){
  const todos=Object.values(familias);
  const adultos=todos.filter(f=>f.entrou).reduce((a,b)=>a+b.adultos,0);
  const criancas=todos.filter(f=>f.entrou).reduce((a,b)=>a+b.criancas,0);

  document.getElementById("resumo").innerHTML=
    `üë§ Adultos: <b>${adultos}</b> ‚Ä¢ üßí Crian√ßas: <b>${criancas}</b>`;
}

function atualizarHistorico(){
  const box=document.getElementById("listaHistorico");
  box.innerHTML="";
  historico.forEach(h=>{
    box.innerHTML+=`<div class="entrada"><strong>${h.nome}</strong> ‚Äî ${h.adultos}A / ${h.criancas}C <span style="float:right">${h.hora}</span></div>`;
  });
}

const btnReset=document.createElement("button");
btnReset.innerText="üßπ Resetar Entradas";
btnReset.style.marginTop="10px";
btnReset.onclick=()=>{
  const senha=prompt("Senha para reset:");
  if(senha!==RESET_PASSWORD) return alert("‚ùå Senha incorreta!");

  Object.values(familias).forEach(f=>f.entrou=false);
  historico=[];
  localStorage.setItem("familias",JSON.stringify(familias));
  localStorage.setItem("historico","[]");
  atualizarHistorico();
  atualizarResumo();
  alert("‚úî Reset conclu√≠do");
};
document.body.appendChild(btnReset);

window.onload=()=>{
  const salvo=localStorage.getItem("familias");
  if(salvo){ familias=JSON.parse(salvo); }
  else { carregarLista(); }
  atualizarResumo();
  atualizarHistorico();
};
</script>
</body>
</html>
