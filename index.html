<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Festa QR</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    background: #f5f5f5;
    display: flex; flex-direction: column;
    align-items: center; min-height: 100vh;
  }
  h1 { text-align: center; font-size: 1.4rem; margin-top: 10px; }
  #reader { width: 90%; max-width: 350px; margin: 10px auto; }
  button, input[type=file] {
    padding: 10px 14px; margin: 5px;
    border: none; border-radius: 6px;
    background: #007bff; color: white;
    font-size: 1rem; cursor: pointer;
  }
  button:hover { background: #0056b3; }
  #resultado {
    margin: 10px auto; width: 90%;
    background: #fff; padding: 10px;
    border-radius: 10px; text-align: center;
    font-size: 1.1rem;
  }
  #resumo {
    background: #e9ecef; width: 90%;
    padding: 10px; border-radius: 10px;
    text-align: center; margin-top: 10px;
  }
  #historico {
    width: 90%; background: #fff; margin-top: 10px;
    padding: 10px; border-radius: 10px;
    max-height: 250px; overflow-y: auto;
    font-size: 0.95rem;
  }
  #historico h3 { margin: 5px 0; text-align: center; }
  .entrada { border-bottom: 1px solid #ccc; padding: 5px 0; }
  .entrada:last-child { border-bottom: none; }
</style>
</head>
<body>
<h1>üéüÔ∏è Controle de Acesso</h1>

<input type="file" id="importar" accept=".json">
<button onclick="iniciarCamera()">üì∑ Iniciar C√¢mera</button>

<div id="reader"></div>
<div id="resultado"></div>
<div id="resumo"></div>
<div id="historico">
  <h3>Hist√≥rico de Entradas</h3>
  <div id="listaHistorico"></div>
</div>

<script>
let familias = {};
let historico = JSON.parse(localStorage.getItem('historico')) || [];

document.getElementById('importar').addEventListener('change', importar);

function importar(evt) {
  const file = evt.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    // Zera o hist√≥rico ao carregar nova lista
    if (confirm('Carregar nova lista ir√° apagar o hist√≥rico atual. Deseja continuar?')) {
      historico = [];
      localStorage.removeItem('historico');
    }

    const data = JSON.parse(e.target.result);
    familias = {};
    data.forEach(f => familias[f.id] = f);
    localStorage.setItem('familias', JSON.stringify(familias));

    alert('‚úÖ Nova lista de fam√≠lias carregada com sucesso!');
    atualizarResumo();
    atualizarHistorico();
  };
  reader.readAsText(file);
}

function iniciarCamera() {
  const leitor = new Html5Qrcode("reader");
  leitor.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 250, height: 250 } },
    (id) => processarQRCode(id, leitor),
    () => {}
  );
}

function processarQRCode(id, leitor) {
  leitor.stop();

  if (!familias[id]) {
    alert('‚ùå QR Code inv√°lido!');
    setTimeout(iniciarCamera, 1000);
    return;
  }

  const f = familias[id];

  if (f.entrou) {
    alert(`‚ö†Ô∏è ${f.nome} j√° entrou anteriormente!`);
  } else {
    f.entrou = true;
    const hora = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    historico.unshift({
      nome: f.nome,
      adultos: f.adultos,
      criancas: f.criancas,
      hora
    });
    if (historico.length > 200) historico.pop();
    localStorage.setItem('familias', JSON.stringify(familias));
    localStorage.setItem('historico', JSON.stringify(historico));
    document.getElementById('resultado').innerHTML = `
      ‚úÖ <strong>${f.nome}</strong><br>
      ${f.adultos} adultos e ${f.criancas} crian√ßas<br>
      <em>Entrada registrada √†s ${hora}</em>`;
    atualizarResumo();
    atualizarHistorico();
  }
  setTimeout(iniciarCamera, 1500);
}

function atualizarResumo() {
  const lista = Object.values(familias);
  const totalFam = lista.length;
  const totalAdultos = lista.filter(f => f.entrou).reduce((s, f) => s + f.adultos, 0);
  const totalCriancas = lista.filter(f => f.entrou).reduce((s, f) => s + f.criancas, 0);

  document.getElementById('resumo').innerHTML = `
    <strong>Total de Fam√≠lias:</strong> ${totalFam} <br>
    <strong>Adultos:</strong> ${totalAdultos} |
    <strong>Crian√ßas:</strong> ${totalCriancas}`;
}

function atualizarHistorico() {
  const lista = document.getElementById('listaHistorico');
  lista.innerHTML = '';
  historico.forEach(h => {
    const div = document.createElement('div');
    div.className = 'entrada';
    div.innerHTML = `<strong>${h.nome}</strong> ‚Äî ${h.adultos}A / ${h.criancas}C 
                     <span style="float:right;color:#666">${h.hora}</span>`;
    lista.appendChild(div);
  });
}

window.onload = function() {
  const data = localStorage.getItem('familias');
  if (data) familias = JSON.parse(data);
  atualizarResumo();
  atualizarHistorico();
};
</script>
</body>
</html>
